<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petition of Support - The Vista An Phu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        header {
            
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 18px;
            opacity: 0.9;
        }
        
.edit-toggle {
    position: absolute;
    right: 10px;
    top: 10px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.3s;
    z-index: 10;
}

.view-responses-btn {
    position: absolute;
    right: 200px;
    top: 10px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.3s;
    z-index: 10;
}


        
        .edit-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        

        .view-responses-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .petition-content {
            padding: 30px;
        }
        
        .edit-mode .petition-content {
            border: 2px dashed #3498db;
            border-radius: 8px;
            margin: 15px;
        }
        
        .petition-text {
            margin-bottom: 20px;
        }
        
        .edit-textarea {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.5;
            resize: vertical;
            margin-bottom: 15px;
            display: none;
            font-family: inherit;
        }
        
        /* Nuevos estilos para el editor de texto enriquecido */
        .editor-container {
            display: none;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .edit-mode .editor-container {
            display: block;
        }
        
        .edit-mode .petition-text {
            display: none;
        }
        
        .toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            padding: 8px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px 6px 0 0;
        }
        
        .toolbar button {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .toolbar button:hover {
            background: #e9ecef;
        }
        
        .toolbar button.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .rich-text-editor {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 0 0 6px 6px;
            font-size: 16px;
            line-height: 1.5;
            resize: vertical;
            font-family: inherit;
        }
        
        .rich-text-editor:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .edit-controls {
            display: none;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .edit-mode .edit-controls {
            display: flex;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-save {
            background: #27ae60;
            color: white;
        }
        
        .btn-save:hover {
            background: #219653;
        }
        
        .btn-cancel {
            background: #e74c3c;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #c0392b;
        }
        
        .form-container2 {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
            position: relative;
            width: 100%;
            max-width: 520px;
            box-sizing: border-box;
        }

        .form-container2 input[type="text"],
        .form-container2 input[type="tel"],
        .form-container2 input[type="date"],
        .form-container2 textarea,
        .form-container2 canvas {
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Centrar y limitar ancho del botón de envío */
        .submit-btn {
            max-width: 520px;
            width: 100%;
            margin: 15px auto 0;
            display: block;
        }
                
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="tel"],
        input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .signature-container {
            margin: 20px 0;
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        canvas {
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            margin-top: 10px;
            width: 100%;
            max-width: 500px;
            touch-action: none;
        }
        
        .clear-btn {
            background: #95a5a6;
            color: white;
            margin: 10px 0;
        }
        
        .clear-btn:hover {
            background: #7f8c8d;
        }
        
        .submit-btn {
            background: #3498db;
            color: white;
            width: 100%;
            justify-content: center;
            margin-top: 15px;
        }
        
        .submit-btn:hover {
            background: #2980b9;
        }
        
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        /* Estilos para elementos editables del header */
        .header-edit {
            display: none;
            width: 100%;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .edit-mode .header-display {
            display: none;
        }
        
        .edit-mode .header-edit {
            display: block;
        }
        
        .header-edit input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 28px;
            text-align: center;
        }
        
        .header-edit input.subtitle-input {
            font-size: 18px;
            opacity: 0.9;
        }
        
        /* Modal de autenticación */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .auth-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .auth-modal h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .auth-modal input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .auth-modal button {
            margin: 5px;
        }
        
        .auth-error {
            color: #e74c3c;
            margin-top: 10px;
            display: none;
        }
        
        /* Modal de respuestas */
        .responses-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .responses-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .responses-modal h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .responses-list {
            margin-top: 20px;
        }
        
        .response-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .response-name {
            font-weight: bold;
            font-size: 18px;
        }
        
        .response-date {
            color: #7f8c8d;
        }
        
        .response-signature {
            margin-top: 15px;
            text-align: center;
        }
        
        .response-signature img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .response-actions {
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .no-responses {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        /* Modal de agradecimiento */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal h2 {
            color: #27ae60;
            margin-bottom: 15px;
        }
        
        .modal p {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .modal-close {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .modal-close:hover {
            background: #2980b9;
        }
        
        /* Modal de carga de configuración */
        #configLoadingModal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        
        .config-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .config-message {
            font-size: 18px;
            text-align: center;
            max-width: 80%;
            margin-bottom: 20px;
        }
        
        .config-error {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            text-align: center;
            max-width: 80%;
        }
        
        .config-retry-btn {
            display: none;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
        }
        
        .config-retry-btn:hover {
            background: #2980b9;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Nuevos estilos para la adaptación */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .warning {
            display: none;
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }
        
        #errorMessage {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
        }
        
        #formRoot {
            display: block;
        }
        
        #ty {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        /* Estilos para el diseño de formulario en columnas */
        .form-columns {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 10px 20px;
        }

        /* Nuevos estilos para centrar el contenedor de firma */
        #signatureContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 520px;
            margin: 0 auto;
        }
        
        @media (max-width: 768px) {
            .form-columns {
                grid-template-columns: 1fr;
            }
            
            .edit-controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .header-edit input {
                font-size: 22px;
            }
            
            .header-edit input.subtitle-input {
                font-size: 16px;
            }
            
            .toolbar {
                flex-wrap: wrap;
            }
            
    .edit-toggle {
        position: absolute;
        top: 10px;
        right: 10px;
        left: auto;
        width: auto;
        padding: 6px 10px;
        font-size: 12px;
    }


                   .view-responses-btn {
       
        position: absolute;
        top: 10px;
        right: 200px;
        left: auto;
        width: auto;
        padding: 6px 10px;
        font-size: 12px;
    }
            .responses-modal-content {
                padding: 15px;
            }
            
            .response-header {
                 top: 10px;
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .response-actions {
                flex-direction: column;
            }


                header {
        padding-bottom: 70px; /* Más espacio para los botones en móvil */
        position: relative;
    }
    .edit-toggle i, .view-responses-btn i {
        font-size: 18px;
    }

    

        }
    </style>
</head>
<body>
    <!-- Modal de autenticación -->
    <div class="auth-modal" id="authModal">
        <div class="auth-modal-content">
            <h2>Authentication Required</h2>
            <p>Please enter the password to enable edit mode:</p>
            <input type="password" id="passwordInput" placeholder="Enter password">
            <div class="auth-error" id="authError">Incorrect password. Please try again.</div>
            <div>
                <button class="btn-save" id="authSubmit">
                    <i class="fas fa-lock"></i> Submit
                </button>
                <button class="btn-cancel" id="authCancel">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de respuestas -->
    <div class="responses-modal" id="responsesModal">
        <div class="responses-modal-content">
            <h2>Submitted Responses</h2>
            <div class="responses-list" id="responsesList">
                <div class="no-responses">Loading responses...</div>
            </div>
            <div class="response-actions">
                <button class="btn-cancel" id="closeResponses">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de carga de configuración -->
    <div id="configLoadingModal">
        <div class="config-spinner"></div>
        <div class="config-message">Loading petition configuration...</div>
        <div class="config-error" id="configError">
            Error loading configuration. Using default petition text.
        </div>
        <button class="config-retry-btn" id="configRetryBtn">Retry</button>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <header>
            <br>
            <div class="header-display">
                <h1 id="headerTitle"></h1>
                <p class="subtitle" id="headerSubtitle"></p>
            </div>
            
            <div class="header-edit">
                <input type="text" id="headerTitleEdit" class="title-input" placeholder="Título de la petición">
                <input type="text" id="headerSubtitleEdit" class="subtitle-input" placeholder="Subtítulo de la petición">
            </div>
            
            <button class="view-responses-btn" id="viewResponsesBtn" style="display: none;">
                <i class="fas fa-list"></i> Responses
            </button>
            
            <button class="edit-toggle" id="editToggle">
                <i class="fas fa-edit"></i> Edit
            </button>
        
        </header>
        
        <div class="petition-content">
            <div class="petition-text" id="petitionText">
                <!-- El contenido se cargará dinámicamente -->
            </div>
            
            <!-- Editor de texto enriquecido -->
            <div class="editor-container">
                <div class="toolbar">
                    <button id="boldBtn" title="Negrita"><i class="fas fa-bold"></i></button>
                    <button id="underlineBtn" title="Subrayado"><i class="fas fa-underline"></i></button>
                </div>
                <div class="rich-text-editor" id="richTextEditor" contenteditable="true"></div>
            </div>
            
            <div class="edit-controls">
                <button class="btn-save" id="saveBtn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button class="btn-cancel" id="cancelBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
            
            <div class="alert alert-success" id="alertSuccess">
                <i class="fas fa-check-circle"></i> Changes saved successfully!
            </div>
            
            <div class="alert alert-error" id="alertError">
                <i class="fas fa-exclamation-circle"></i> Error saving changes. Please try again.
            </div>
        </div>
        
        <div id="formRoot">
            <div class="form-columns">
                <div class="form-container2" id="guestNameContainer">
                    <label for="guestName">Guest Name:</label>
                    <input type="text" id="guestName" name="guestName" required>
                    <div class="warning">Please enter your name</div>
                </div>
                
                <div class="form-container2" id="dateContainer">
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date" required>
                    <div class="warning">Please select a date</div>
                </div>
            </div>
            
            <div class="form-container2" id="signatureContainer">
                <label>Signature:</label>
                <canvas id="signature" width="500" height="200"></canvas>
                <div class="warning">Please provide your signature</div>
                <button class="clear-btn" id="clearButton">
                    <i class="fas fa-eraser"></i> Clear Signature
                </button>
            </div>
            
            <div id="errorMessage"></div>
            
            <button class="submit-btn" id="submit">
                <i class="fas fa-paper-plane"></i> Submit
            </button>
        </div>
        
        <div id="ty" style="display: none;">
            <h2>Thank You!</h2>
            <p>Your signature has been successfully submitted. Thank you for supporting our petition.</p>
        </div>
        
        <footer>
            <p>The Vista An Phu Resident Committee © 2023 | For support, please contact: support@vistaanphu.org</p>
        </footer>
    </div>

    <!-- Overlay de carga -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p>Submitting your response, please wait...</p>
    </div>

    <script>
        // Contenido predeterminado hardcodeado
        const DEFAULT_CONFIG = {
            title: "SIGNATURE FORM",
            subtitle: "",
            content: ``
        };

        document.addEventListener('DOMContentLoaded', function() {
            const authModal = document.getElementById('authModal');
            const passwordInput = document.getElementById('passwordInput');
            const authError = document.getElementById('authError');
            const authSubmit = document.getElementById('authSubmit');
            const authCancel = document.getElementById('authCancel');
            
            const responsesModal = document.getElementById('responsesModal');
            const responsesList = document.getElementById('responsesList');
            const viewResponsesBtn = document.getElementById('viewResponsesBtn');
            const closeResponses = document.getElementById('closeResponses');
            
            const configLoadingModal = document.getElementById('configLoadingModal');
            const configError = document.getElementById('configError');
            const configRetryBtn = document.getElementById('configRetryBtn');
            const mainContainer = document.getElementById('mainContainer');
            
            const petitionText = document.getElementById('petitionText');
            const editToggle = document.getElementById('editToggle');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const alertSuccess = document.getElementById('alertSuccess');
            const alertError = document.getElementById('alertError');
            
            // Elementos para el editor de texto enriquecido
            const richTextEditor = document.getElementById('richTextEditor');
            const boldBtn = document.getElementById('boldBtn');
            const underlineBtn = document.getElementById('underlineBtn');
            
            // Elementos para el header editable
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            const headerTitleEdit = document.getElementById('headerTitleEdit');
            const headerSubtitleEdit = document.getElementById('headerSubtitleEdit');
            
            // Canvas/signature functionality
            const canvas = document.getElementById("signature");
            const ctx = canvas.getContext("2d");
            const clearButton = document.getElementById("clearButton");
            let drawing = false;
            let canvasBackup = null; // Para guardar el estado del canvas
            
            // Establecer la fecha actual por defecto
            document.getElementById('date').valueAsDate = new Date();
            
            // URL del backend para guardar/recuperar configuración
            const CONFIG_BACKEND_URL = "https://script.google.com/macros/s/AKfycbxxQkdD4R91TVgCueQzlaBbYsszTrTbqtcE4UdtaxAQQ_vIsNNaYM4CXvwu_CkgyUyhzw/exec";
            
            // Función para guardar el estado actual del canvas
            function backupCanvas() {
                canvasBackup = canvas.toDataURL();
            }
            
            // Función para restaurar el estado del canvas
            function restoreCanvas() {
                if (canvasBackup) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = canvasBackup;
                }
            }
            
            // Función para cargar la configuración desde el backend
            async function loadConfigFromBackend() {
                try {
                    const response = await fetch(`${CONFIG_BACKEND_URL}?action=getConfig`);
                    const result = await response.json();
                    
                    if (result.success && result.config) {
                        return result.config;
                    }
                    return null;
                } catch (error) {
                    console.error('Error loading config from backend:', error);
                    throw error;
                }
            }
            
            // Función para inicializar la configuración
            async function initializeConfig() {
                try {
                    const config = await loadConfigFromBackend();
                    
                    if (config) {
                        // Usar configuración del backend
                        petitionText.innerHTML = config.content || DEFAULT_CONFIG.content;
                        headerTitle.textContent = config.title || DEFAULT_CONFIG.title;
                        headerSubtitle.textContent = config.subtitle || DEFAULT_CONFIG.subtitle;
                    } else {
                        // Usar configuración predeterminada
                        useDefaultConfig();
                    }
                    
                    // Actualizar campos de edición
                    headerTitleEdit.value = headerTitle.textContent;
                    headerSubtitleEdit.value = headerSubtitle.textContent;
                    
                    // Ocultar modal y mostrar contenido
                    configLoadingModal.style.display = 'none';
                    mainContainer.style.display = 'block';
                    
                    // Inicializar eventos para detectar cuando se abre el teclado
                    initKeyboardEvents();
                    
                } catch (error) {
                    // Error al cargar configuración
                    configError.style.display = 'block';
                    configRetryBtn.style.display = 'block';
                    
                    // Usar configuración predeterminada
                    useDefaultConfig();
                    
                    // Ocultar modal y mostrar contenido después de un breve retraso
                    setTimeout(() => {
                        configLoadingModal.style.display = 'none';
                        mainContainer.style.display = 'block';
                        // Inicializar eventos para detectar cuando se abre el teclado
                        initKeyboardEvents();
                    }, 2000);
                }
            }
            
            // Inicializar eventos para detectar cuando se abre el teclado
            function initKeyboardEvents() {
                // Detectar cuando un campo de entrada obtiene el foco (se va a abrir el teclado)
                const inputs = document.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        // Guardar el estado actual del canvas
                        backupCanvas();
                    });
                    
                    input.addEventListener('blur', function() {
                        // Restaurar el canvas si se perdió el contenido
                        setTimeout(restoreCanvas, 300);
                    });
                });
                
                // También detectar cambios en la orientación o redimensionamiento de la ventana
                window.addEventListener('resize', function() {
                    // Restaurar el canvas después de un redimensionamiento
                    setTimeout(restoreCanvas, 100);
                });
            }
            
            // Función para usar la configuración predeterminada
            function useDefaultConfig() {
                petitionText.innerHTML = DEFAULT_CONFIG.content;
                headerTitle.textContent = DEFAULT_CONFIG.title;
                headerSubtitle.textContent = DEFAULT_CONFIG.subtitle;
            }
            
            // Inicializar la configuración al cargar la página
            initializeConfig();
            
            // Botón para reintentar carga de configuración
            configRetryBtn.addEventListener('click', function() {
                configError.style.display = 'none';
                configRetryBtn.style.display = 'none';
                initializeConfig();
            });
            
            // Check if we're in edit mode from URL
            const urlParams = new URLSearchParams(window.location.search);
            const isEditMode = urlParams.get('edit') === 'true';
            
            if (isEditMode) {
                showAuthModal();
            }
            
            // Edit mode toggle - muestra el modal de autenticación
            editToggle.addEventListener('click', function() {
                if (!mainContainer.classList.contains('edit-mode')) {
                    showAuthModal();
                } else {
                    disableEditMode();
                    history.replaceState({}, '', window.location.pathname);
                }
            });
            
            // Mostrar modal de respuestas
            viewResponsesBtn.addEventListener('click', function() {
                showResponsesModal();
            });
            
            // Cerrar modal de respuestas
            closeResponses.addEventListener('click', function() {
                responsesModal.style.display = 'none';
            });
            
            // Mostrar modal de autenticación
            function showAuthModal() {
                authModal.style.display = 'flex';
                passwordInput.value = '';
                authError.style.display = 'none';
                passwordInput.focus();
            }
            
            // Ocultar modal de autenticación
            function hideAuthModal() {
                authModal.style.display = 'none';
            }
            
            // Mostrar modal de respuestas
            function showResponsesModal() {
                responsesModal.style.display = 'flex';
                loadResponses();
            }
            
            // Verificar contraseña
            function checkPassword() {
                if (passwordInput.value === 'sava2025') {
                    hideAuthModal();
                    enableEditMode();
                    history.replaceState({}, '', window.location.pathname + '?edit=true');
                    return true;
                } else {
                    authError.style.display = 'block';
                    passwordInput.focus();
                    return false;
                }
            }
            
            // Cargar respuestas desde el backend
            async function loadResponses() {
                responsesList.innerHTML = '<div class="no-responses">Loading responses...</div>';
                
                try {
                    const response = await fetch(`${CONFIG_BACKEND_URL}?action=getResponses`);
                    const result = await response.json();
                    
                    if (result.success && result.responses && result.responses.length > 0) {
                        displayResponses(result.responses);
                    } else {
                        responsesList.innerHTML = '<div class="no-responses">No responses found.</div>';
                    }
                } catch (error) {
                    console.error('Error loading responses:', error);
                    responsesList.innerHTML = '<div class="no-responses">Error loading responses. Please try again.</div>';
                }
            }
            
            // Mostrar respuestas en el modal
            function displayResponses(responses) {
                responsesList.innerHTML = '';
                
                responses.forEach((response, index) => {
                    const responseItem = document.createElement('div');
                    responseItem.className = 'response-item';
                    
                    // Formatear la fecha si está disponible
                    let formattedDate = 'No date provided';
                    if (response.date) {
                        const dateObj = new Date(response.date);
                        if (!isNaN(dateObj.getTime())) {
                            formattedDate = dateObj.toLocaleDateString();
                        }
                    }
                    
                    responseItem.innerHTML = `
                        <div class="response-header">
                            <div class="response-name">${response.guestName || 'Anonymous'}</div>
                            <div class="response-date">${formattedDate}</div>
                        </div>
                        <div class="response-details">
                            <p><strong>Name:</strong> ${response.guestName || 'Not provided'}</p>
                            <p><strong>Date:</strong> ${formattedDate}</p>
                        </div>
                        ${response.signatureData ? `
                        <div class="response-signature">
                            <p><strong>Signature:</strong></p>
                            <img src="${response.signatureData}" alt="Signature">
                        </div>
                        ` : ''}
                        <div class="response-actions">
                            <button class="btn-save download-pdf" data-index="${index}">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                        </div>
                    `;
                    
                    responsesList.appendChild(responseItem);
                });
                
                // Añadir event listeners a los botones de descarga
                document.querySelectorAll('.download-pdf').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        generatePDF(responses[index]);
                    });
                });
            }
            
            // Generar PDF para una respuesta (función corregida)
            async function generatePDF(response) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Título
                doc.setFontSize(20);
                doc.text("PETITION RESPONSE", 105, 20, { align: 'center' });
                
                // Línea separadora
                doc.setDrawColor(0);
                doc.setLineWidth(0.5);
                doc.line(20, 25, 190, 25);
                
                // Información de la respuesta
                doc.setFontSize(12);
                let yPosition = 35;
                
                // Nombre
                doc.setFont(undefined, 'bold');
                doc.text("Name:", 20, yPosition);
                doc.setFont(undefined, 'normal');
                doc.text(response.guestName || 'Not provided', 60, yPosition);
                yPosition += 10;
                
                // Fecha
                let formattedDate = 'No date provided';
                if (response.date) {
                    const dateObj = new Date(response.date);
                    if (!isNaN(dateObj.getTime())) {
                        formattedDate = dateObj.toLocaleDateString();
                    }
                }
                
                doc.setFont(undefined, 'bold');
                doc.text("Date:", 20, yPosition);
                doc.setFont(undefined, 'normal');
                doc.text(formattedDate, 60, yPosition);
                yPosition += 15;
                
                // Firma
                if (response.signatureData) {
                    doc.setFont(undefined, 'bold');
                    doc.text("Signature:", 20, yPosition);
                    yPosition += 10;
                    
                    try {
                        // Extraer solo la parte base64 del data URI
                        const base64Data = response.signatureData.replace(/^data:image\/png;base64,/, '');
                        
                        // Añadir la imagen de la firma
                        doc.addImage(base64Data, 'PNG', 20, yPosition, 100, 40);
                        yPosition += 50;
                    } catch (error) {
                        console.error('Error adding signature to PDF:', error);
                        doc.text("Error displaying signature", 20, yPosition);
                        yPosition += 10;
                    }
                }
                
                // Línea separadora
                yPosition += 5;
                doc.line(20, yPosition, 190, yPosition);
                yPosition += 10;
                
                // Información de la petición
                doc.setFont(undefined, 'bold');
                doc.text("Petition Details:", 20, yPosition);
                yPosition += 10;
                
                doc.setFont(undefined, 'normal');
                const petitionTitle = headerTitle.textContent;
                const petitionSubtitle = headerSubtitle.textContent;
                
                doc.text(`Title: ${petitionTitle}`, 20, yPosition);
                yPosition += 7;
                doc.text(`Subtitle: ${petitionSubtitle}`, 20, yPosition);
                yPosition += 10;
                
                // Fecha de generación del PDF
                const now = new Date();
                doc.setFontSize(10);
                doc.text(`PDF generated on: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, 20, 280);
                
                // Guardar el PDF
                const fileName = `petition_response_${response.guestName || 'anonymous'}_${formattedDate.replace(/\//g, '-')}.pdf`;
                doc.save(fileName);
            }
            
            function enableEditMode() {
                mainContainer.classList.add('edit-mode');
                richTextEditor.innerHTML = petitionText.innerHTML;
                headerTitleEdit.value = headerTitle.textContent;
                headerSubtitleEdit.value = headerSubtitle.textContent;
                editToggle.innerHTML = '<i class="fas fa-times"></i> View Mode';
                viewResponsesBtn.style.display = 'block';
            }
            
            function disableEditMode() {
                mainContainer.classList.remove('edit-mode');
                editToggle.innerHTML = '<i class="fas fa-edit"></i> Edit';
                viewResponsesBtn.style.display = 'none';
            }
            
            // Funcionalidad para botones de formato
            boldBtn.addEventListener('click', function() {
                document.execCommand('bold', false, null);
                updateButtonState();
            });
            
            underlineBtn.addEventListener('click', function() {
                document.execCommand('underline', false, null);
                updateButtonState();
            });
            
            function updateButtonState() {
                // Actualizar estado de los botones
                boldBtn.classList.toggle('active', document.queryCommandState('bold'));
                underlineBtn.classList.toggle('active', document.queryCommandState('underline'));
            }
            
            // Eventos para actualizar el estado de los botones
            richTextEditor.addEventListener('mouseup', updateButtonState);
            richTextEditor.addEventListener('keyup', updateButtonState);
            
            // Función para guardar la configuración en el backend
            async function saveConfigToBackend(config) {
                try {
                    const response = await fetch(CONFIG_BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify({
                            action: 'saveConfig',
                            config: config
                        })
                    });
                    
                    const result = await response.json();
                    return result.success;
                } catch (error) {
                    console.error('Error saving config to backend:', error);
                    return false;
                }
            }
            
            // Save content
            saveBtn.addEventListener('click', async function() {
                try {
                    petitionText.innerHTML = richTextEditor.innerHTML;
                    headerTitle.textContent = headerTitleEdit.value;
                    headerSubtitle.textContent = headerSubtitleEdit.value;
                    
                    // Guardar en el backend
                    const config = {
                        content: richTextEditor.innerHTML,
                        title: headerTitleEdit.value,
                        subtitle: headerSubtitleEdit.value
                    };
                    
                    const saveSuccess = await saveConfigToBackend(config);
                    
                    if (saveSuccess) {
                        // Show success message
                        alertSuccess.style.display = 'block';
                        alertError.style.display = 'none';
                        
                        // Hide success message after 3 seconds
                        setTimeout(() => {
                            alertSuccess.style.display = 'none';
                        }, 3000);
                    } else {
                        throw new Error('Failed to save to backend');
                    }
                } catch (error) {
                    // Show error message
                    alertError.style.display = 'block';
                    alertSuccess.style.display = 'none';
                    
                    // Hide error message after 3 seconds
                    setTimeout(() => {
                        alertError.style.display = 'none';
                    }, 3000);
                }
            });
            
            // Cancel editing
            cancelBtn.addEventListener('click', function() {
                richTextEditor.innerHTML = petitionText.innerHTML;
                headerTitleEdit.value = headerTitle.textContent;
                headerSubtitleEdit.value = headerSubtitle.textContent;
                disableEditMode();
                history.replaceState({}, '', window.location.pathname);
            });
            
            // Canvas drawing functionality
            function resizeCanvas() {
                const maxWidth = 500;
                const width = Math.min(window.innerWidth * 0.9, maxWidth);
                canvas.width = width;
                canvas.height = width * 0.4;
                
                // Restaurar el contenido del canvas después del redimensionamiento
                restoreCanvas();
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            function getCanvasPosition() {
                const rect = canvas.getBoundingClientRect();
                return {
                    offsetX: rect.left,
                    offsetY: rect.top
                };
            }
            
            // Mouse events
            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mouseup", stopDrawing);
            canvas.addEventListener("mousemove", draw);
            
            // Touch events
            canvas.addEventListener("touchstart", startDrawingTouch);
            canvas.addEventListener("touchend", stopDrawingTouch);
            canvas.addEventListener("touchmove", drawTouch);
            
            function startDrawing(e) {
                drawing = true;
                ctx.beginPath();
                draw(e);
            }
            
            function startDrawingTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const canvasPos = getCanvasPosition();
                startDrawing({
                    offsetX: touch.clientX - canvasPos.offsetX,
                    offsetY: touch.clientY - canvasPos.offsetY
                });
            }
            
            function stopDrawing() {
                drawing = false;
                ctx.beginPath();
                // Guardar el estado actual después de terminar de dibujar
                backupCanvas();
            }
            
            function stopDrawingTouch(e) {
                e.preventDefault();
                if (e.touches.length === 0) {
                    stopDrawing();
                }
            }
            
            function draw(e) {
                if (!drawing) return;
                const x = e.offsetX;
                const y = e.offsetY;
                ctx.lineWidth = 2;
                ctx.lineCap = "round";
                ctx.strokeStyle = "black";
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
            
            function drawTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const canvasPos = getCanvasPosition();
                draw({
                    offsetX: touch.clientX - canvasPos.offsetX,
                    offsetY: touch.clientY - canvasPos.offsetY
                });
            }
            
            // Clear canvas
            clearButton.addEventListener('click', function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Actualizar el backup después de limpiar
                backupCanvas();
            });
            
            // Función para mostrar errores
            function showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                // Ocultar después de 5 segundos
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
            
            // Función de envío adaptada
            async function send() {
                const submitBtn = document.getElementById("submit");
                const overlay = document.getElementById("loadingOverlay");
                const errorDiv = document.getElementById('errorMessage');

                errorDiv.style.display = 'none';
                submitBtn.disabled = true;
                overlay.style.display = "flex";

                let hasError = false;
                let firstErrorElement = null;
                const payload = {};

                // Recorremos todos los form-container2 dinámicos
                document.querySelectorAll(".form-container2").forEach(container => {
                    const input = container.querySelector("input, textarea, select, canvas");
                    if (!input) return;

                    const name = input.name || container.id;
                    const warning = container.querySelector(".warning");

                    let value;
                    let isEmpty = false;

                    if (input.tagName === "CANVAS") {
                        // Verificar si el canvas de firma está vacío
                        const ctx = input.getContext("2d");
                        const imageData = ctx.getImageData(0, 0, input.width, input.height).data;
                        isEmpty = true;

                        for (let i = 0; i < imageData.length; i += 4) {
                            if (imageData[i + 3] !== 0) {
                                isEmpty = false;
                                break;
                            }
                        }

                        if (!isEmpty) {
                            value = {
                                filename: `signature_${Date.now()}.png`,
                                mimeType: "image/png",
                                data: input.toDataURL("image/png").split(",")[1]
                            };
                        }
                    } else if (input.type === "radio" || input.type === "checkbox") {
                        const checked = container.querySelectorAll("input:checked");
                        isEmpty = checked.length === 0;

                        if (!isEmpty) {
                            value = [...checked].map(el => el.value);
                            if (input.type === "radio") value = value[0]; // un único valor
                        }
                    } else if (input.tagName === "SELECT") {
                        // Dropdown
                        isEmpty = input.value === "";
                        value = input.value;
                    } else {
                        // Texto, textarea, fecha, hora
                        value = input.value.trim();
                        isEmpty = !value;
                    }

                    // Mostrar advertencias
                    if (isEmpty && warning) {
                        warning.style.display = "block";
                        hasError = true;
                        if (!firstErrorElement) firstErrorElement = container;
                    } else if (warning) {
                        warning.style.display = "none";
                    }

                    payload[name] = value;
                });

                if (hasError) {
                    if (firstErrorElement) {
                        firstErrorElement.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                    submitBtn.disabled = false;
                    overlay.style.display = 'none';
                    return;
                }

                try {
                    const response = await fetch(CONFIG_BACKEND_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.success) {
                        document.getElementById("formRoot").style.display = "none";
                        document.getElementById("ty").style.display = "block";
                    } else {
                        showError("Error al enviar los datos: " + result.error);
                    }

                } catch (err) {
                    console.error("Error al enviar datos:", err);
                    showError("Error de conexión. Por favor, intenta nuevamente.");
                } finally {
                    submitBtn.disabled = false;
                    overlay.style.display = 'none';
                }
            }
            
            // Event listener para el botón de envío
            document.getElementById("submit").addEventListener("click", send);
            
            // Event listeners para autenticación
            authSubmit.addEventListener('click', checkPassword);
            
            authCancel.addEventListener('click', function() {
                hideAuthModal();
            });
            
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        });
    </script>
</body>
</html>
